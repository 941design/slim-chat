# Nostling

A desktop messaging application built on the Nostr protocol with secure auto-updates, built with Electron, React, and TypeScript.

## Features

+ **QR code contact management** - Scan QR codes via camera or display npub as QR code
+ change aliases
+ remove contacts
+ menu
  + identities ?
	+ add/remove
  + contacts ?
	+ add/remove/edit
  + about
	+ doc
    + repo
    + version
    + status
  + themes
	+ each color theme should provide dark and light variant
    + preview in main panel
    + cancel/save
  + relays
+ avatars (generated by llm) train/distill?
+ group chat
  + fake groups with custom message
  + add member (adding a member creates new id (deterministically?), and starts new chat)
+ rename identities to something more intuitive (profile?)
+ contact online status?
  + only practical if listening to all messages sent by a contact. (last seen ... ago)
+ languages
+ send on enter/shift enter

## Build

+ disallow pushing tags on branches other than master
+ add config dir command line param

## Styling

+ themes
  + one dark one light each
  + banner image
  + fonts
+ larger initial screen size.
+ save screen size in config
+ keep chat window fixed
+ vertically shrink footer
+ add splash screen with nostling
+ create 

## Release

+ compress git history
+ compress migrations into one initial migration
+ remove old versions
+ tidy up repo
+ tidy up ~/Library/Application Support/nostling/


## Features

- **Nostr encrypted messaging** with NIP-04 encryption via nostr-tools
- **Identity management** - Create/import identities from nsec keys
- **Contact whitelist** - Only receive messages from known contacts
- **QR code contact management** - Scan QR codes via camera to add contacts or display identity npub as scannable QR code
- **Relay connectivity** - WebSocket connections to Nostr relays with auto-reconnection
- **Relay management** - Compact table with drag-and-drop reordering, per-relay read/write policies, and live connection status
- **Offline support** - Queue messages when offline, publish when connectivity restored
- **Secure auto-updates** with RSA-4096 cryptographic verification
- **Auto-update footer** with real-time progress, configurable check intervals, and manual refresh
- **Ostrich-themed status messages** - Playful, randomly-selected status messages throughout the app
- **Theme customization** - Per-identity theme selection with 10 distinctive color schemes
- **Persistence layer** with SQLite database and automatic schema migrations
- **Cross-platform** support for macOS and Linux
- **Dev mode testing** for validating updates before release
- Built with Electron 30, React 18, and TypeScript

### Ostrich-Themed Status Messages

Throughout the app, status messages use playful ostrich-themed language instead of standard technical terms:

- Update status: "Standing tall" (up to date), "Pecking up" (downloading), "Eyes peeled" (checking)
- Nostling queue: "Flock gathered" (messages queued), "Wings spread" (sending), "Nestling in" (receiving)
- Error states: "Ruffled feathers" (errors), "Head in sand" (offline)

Each status type randomly selects from 2-3 themed alternatives on every display, keeping the experience fresh while preserving all dynamic content like versions, progress percentages, and error details.

### Theme Customization

Each identity can have its own visual theme, allowing you to distinguish identities at a glance or match your personal preferences.

**Available themes:**
- **Light** - Clean, bright interface
- **Dark** - Default dark theme
- **Sunset** - Warm oranges and pinks
- **Ocean** - Cool blues and teals
- **Forest** - Natural greens
- **Purple Haze** - Deep purples
- **Ember** - Fiery reds and oranges
- **Twilight** - Muted blues and purples
- **Mint** - Fresh mint greens
- **Amber** - Golden yellows

**To select a theme:**
1. Click the hamburger menu (three horizontal lines) in the top-right
2. Click "Theme" to open the theme selector
3. Click on any theme to apply it immediately
4. Your theme choice is saved per-identity in the database

Themes are applied instantly when selected and persist across application restarts. If you switch to a different identity, the app will display that identity's saved theme.

### QR Code Contact Management

Add contacts by scanning QR codes or share your identity's npub as a scannable QR code.

**To scan a contact's QR code:**
1. Open the contact management modal
2. Click the camera icon button to activate the scanner
3. Point your camera at a QR code containing a Nostr npub
4. The scanned npub will populate the input field for review
5. Verify the npub and add the contact

**To display your identity as a QR code:**
1. Navigate to the identity list
2. Click the QR code icon next to your identity
3. A modal displays your npub as a scannable QR code
4. Other users can scan this with their camera to add you as a contact

**Features:**
- Theme-aware QR codes adapt colors for light and dark themes
- Performance optimized with 20fps frame rate limiting
- Automatic camera cleanup and resource management
- Database constraint prevents duplicate contacts

## Quick Start

```bash
npm install
npm run dev
```

## Installation

### macOS

This app is not notarized with Apple. On first launch, macOS will block it.

1. Download the `.dmg` from the [latest release](https://github.com/941design/nostling/releases/latest)
2. Open the DMG and drag `Nostling.app` to **Applications**
3. Try opening the app (it will fail with a warning)
4. Go to **System Settings → Privacy & Security**
5. Find the blocked app message and click **"Allow Anyway"**
6. Open the app again and click **"Open"**

**Alternative**: Right-click the app → **Open** → **Open**, or run:
```bash
xattr -rd com.apple.quarantine /Applications/Nostling.app
```

### Linux

1. Download the `.AppImage` from the [latest release](https://github.com/941design/nostling/releases/latest)
2. Make executable and run:
   ```bash
   chmod +x Nostling-*.AppImage
   ./Nostling-*.AppImage
   ```

## Development

### Commands

| Command | Description |
|---------|-------------|
| `make dev` | Start with hot reload |
| `make build` | Production build |
| `make test` | Unit tests |
| `make test-e2e` | End-to-end tests |
| `make lint` | Type checking |
| `make package` | Create distributable packages |
| `make release` | Full release build |

Run `make help` for all available commands.

### Individual Process Development

```bash
npm run dev:main      # Main process only
npm run dev:preload   # Preload script only
npm run dev:renderer  # Frontend only
```

### Testing

```bash
npm test                    # Unit tests
npm run test:watch          # Watch mode
npm run test:e2e            # E2E tests (headless)
npm run test:e2e:ui         # E2E interactive runner
npm run test:e2e:headed     # E2E with visible window
npm run test:e2e:debug      # E2E with Playwright Inspector
npm run test:e2e:docker     # E2E in Docker (simulates CI)
```

### Dev Mode Update Testing

Test the auto-update system locally before releasing:

```bash
# Basic dev mode
make dev

# Test against specific release
DEV_UPDATE_SOURCE=https://github.com/941design/nostling/releases/download/1.0.0 make dev

# Test with local manifest
DEV_UPDATE_SOURCE=file:///tmp/test-updates make dev

# Test pre-release versions
ALLOW_PRERELEASE=true make dev
```

See [docs/dev-mode-update-testing.md](docs/dev-mode-update-testing.md) for comprehensive testing guide.

## Building & Packaging

### Production Build

```bash
npm run build
```

### Create Packages

```bash
npm run package
```

Creates platform-specific distributables:
- **macOS**: DMG and ZIP
- **Linux**: AppImage

## Release Process

### Creating a Release

1. Bump version (creates tag without 'v' prefix):
   ```bash
   make version-patch   # or version-minor, version-major
   ```

2. Push to trigger automated release:
   ```bash
   git push && git push --tags
   ```

The GitHub Actions workflow will build packages, sign the manifest, and create the release.

**Important**: Tags must be `x.x.x` format (e.g., `1.0.0`), not `v1.0.0`.

### Local Release Build

```bash
make release
```

Artifacts will be in the `release/` directory.

## Configuration

The app stores configuration and data in:
- **macOS**: `~/Library/Application Support/Nostling/`
- **Linux**: `~/.config/Nostling/`

Files:
- `config.json` - Application configuration
- `nostling.db` - SQLite database for application state
- `identities/<id>/relays.json` - Per-identity relay configurations with read/write policies

## Log Files

Logs are written to:
- **macOS**: `~/Library/Application Support/Nostling/logs/app.log`
- **Linux**: `~/.config/Nostling/logs/app.log`

Format: JSON Lines with `level`, `message`, and `timestamp` fields.

## Security

- **RSA-4096 signature verification** on all update manifests
- **SHA-256 hash verification** on downloaded artifacts
- **Version validation** prevents downgrade attacks
- **HTTPS-only** update delivery in production

For RSA key setup, see [docs/rsa-key-setup.md](docs/rsa-key-setup.md).

### macOS Code Signing

This app is intentionally unsigned (`identity: null`). This avoids Gatekeeper issues with ad-hoc signatures on auto-updated apps. Users approve the app once during installation; subsequent updates work without additional prompts.

## Documentation

- [Architecture](docs/architecture.md) - Technical architecture and design
- [Dev Mode Update Testing](docs/dev-mode-update-testing.md) - Testing auto-updates locally
- [RSA Key Setup](docs/rsa-key-setup.md) - Cryptographic key configuration
- [E2E Tests](e2e/README.md) - End-to-end test documentation

## License

MIT
