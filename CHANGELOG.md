# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Fixed
- **P2P Connection Resource Exhaustion (Severity 8)**: Batch simultaneous P2P connection attempts to prevent renderer event loop blocking
  - With 50+ contacts, parallel RTCPeerConnection creation blocked event loop
  - Added `MAX_CONCURRENT_CONNECTIONS: 5` to P2P_CONFIG
  - Batched connection attempts (5 at a time) with 500ms delays between batches
  - Bug report: bug-reports/bug-003-resource-exhaustion.md
- **P2P IPC Routing Bug (Severity 7)**: Fixed signal routing callback dispatching to both handlers regardless of channel
  - Signal routing callback now conditionally dispatches based on channel parameter
  - Prevents incorrect message dispatch for `p2p:initiate-connection` vs `p2p:remote-signal`
  - Bug report: bug-reports/bug-004-ipc-dispatch.md
- **P2P Database Race Condition (Severity 7)**: Wrapped p2p_connection_state writes in transactions
  - Concurrent writes to p2p_connection_state now protected with BEGIN/COMMIT/ROLLBACK
  - Prevents race conditions with multiple simultaneous connection status updates
  - Bug report: bug-reports/bug-005-race-condition.md
- **P2P Error Logging Enhancement (Severity 7)**: Added comprehensive WebRTC error logging
  - Added ICE gathering state change handlers (`onicegatheringstatechange`)
  - Added ICE connection state change handlers (`oniceconnectionstatechange`)
  - Added DataChannel error and close handlers (`onerror`, `onclose`)
  - Added `.catch()` to all WebRTC promise chains (createOffer, setLocalDescription, createAnswer, setRemoteDescription)
  - Includes session ID and phase information in all failure logs
  - Bug report: bug-reports/bug-006-error-logging.md

### Added
- **YAML Configuration Format**: Migrated configuration files from JSON to YAML format
  - App config (`config.yaml`) and per-identity relay configs (`relays.yaml`) now use YAML with helpful comments
  - Automatic lazy migration: JSON configs are converted to YAML on first read
  - Backwards compatible: Original JSON files preserved for downgrade safety
  - Dual-write support: While JSON files exist, both formats are kept in sync
  - Deprecation warnings: Info messages logged when both formats exist
  - YAML files include helpful comments explaining each configuration option
  - Hash-based conflict detection for relay configs prevents accidental overwrites
  - Property-based tests: 120+ tests covering migration, round-trip, and conflict detection
  - JSON format will be auto-removed in the next major version

- **Emoji Picker**: Integrated emoji insertion with accessibility and layout resilience
  - 26 emojis displayed in a 4×7 grid layout accessible from message input field
  - Emoji button positioned in bottom-right corner of textarea using relative units (rem)
  - Click emoji to insert at cursor position, preserving surrounding text
  - WCAG Level A accessibility compliance with proper ARIA roles and labels
  - Full keyboard navigation: Arrow keys move focus, Enter/Space selects emoji
  - Screen reader support with descriptive aria-label for each emoji
  - Layout resilient positioning prevents overlap with text input
  - Theme-aware colors adapt to active theme via useThemeColors() hook
  - Menu pattern with Portal positioning for proper z-index layering
  - Automatic menu close on emoji selection or outside click
  - Property-based integration tests: 30 tests covering insertion logic, cursor positioning, keyboard navigation, and accessibility
  - Total test suite: 1801 tests, all passing with zero regressions

### Security
- **Secret Storage Hardening**: Enhanced security for identity secret management
  - Removed plaintext fallback for decryption failures - strict enforcement of OS keychain encryption
  - Structured error propagation from storage layer through IPC to UI with `SecretDecryptionError` and `SecureStorageUnavailableError` types
  - Graceful error handling in UI with clear user feedback when secrets cannot be loaded
  - Dev mode detection via `NOSTLING_DATA_DIR` continues to use plaintext encoding (development only)
  - Production mode enforces OS keychain (`safeStorage`) for all secret operations
  - Property-based integration tests: 32 tests covering error propagation, type safety, and recovery procedures
  - Total test suite: 1467 tests, all passing with zero regressions

### Added
- **Contacts Panel with Disk-Cached Images**: View full contact profiles with offline-capable image caching
  - Accessible from hamburger menu via "View Contact Profiles" menu item
  - Display all profile fields: Name, About, Picture, Banner, Website, NIP-05, Lightning Address (lud16)
  - Banner displayed as header background image (social media style)
  - Profile picture overlaid on banner with fallback to letter circle
  - Sidebar shows contact list filtered by selected identity
  - Contact selection with visual highlighting (border and background)
  - Disk-based image cache with LRU eviction (100MB limit) for offline access
  - Cache location: Electron userData directory with 0o700/0o600 permissions
  - SHA-256 URL hashing for cache keys with metadata tracking
  - Only re-fetches images when URL changes (compares cached URL with current)
  - Integration with existing XSS protection via url-sanitizer.ts
  - IPC API namespace: `window.api.nostling.imageCache.*` (getCachedImage, cacheImage, invalidateCache)
  - Read-only profiles: contacts cannot edit other contacts' information
  - Graceful offline degradation: shows cached images or fallbacks when network unavailable
  - Property-based tests: 268 unit tests covering all components
  - Integration tests: 5 tests verifying IPC channel correctness and cache flow
  - Total test suite: 1740 tests, all passing with zero regressions
  - Components: ImageCacheService, CacheDatabase, ImageFetcher, CachedImage, ContactsPanel
- **Identity Profile Editor Panel**: Full-featured profile editing interface with live preview
  - Accessible from hamburger menu via "Edit Identity Profile" menu item
  - Edit 8 profile fields: Label (internal), Name, About, Picture URL, Banner URL, Website, NIP-05, Lightning Address (lud16)
  - Staging pattern: changes tracked immediately, Apply button enables when dirty
  - Live image preview for Picture and Banner URL fields with error handling
  - Apply/Cancel buttons with save operation locking to prevent conflicts
  - Escape key closes panel (except during save operations)
  - Profile updates automatically broadcast to all contacts via encrypted messages
  - View mode: replaces conversation pane with full-width panel (identities mode)
  - Sidebar content swap: hamburger menu replaced by Cancel/Apply buttons when panel open
  - Property-based integration tests: 14 E2E tests covering menu access, field editing, apply/cancel, persistence, and escape handling
  - Total test suite: 1435 tests, all passing with zero regressions
- **Profile Avatars with Status Badges**: Visual profile representation with status indicators
  - Avatar component displays profile pictures or letter circles based on display name
  - Status badge overlay shows profile type: shield check (private), shield warning (public), shield off (none)
  - Integrated in identity lists, contact lists, and conversation views
  - XSS protection for profile picture URLs through sanitization
  - WCAG AA compliant badge contrast with enhanced visibility (border and shadow)
  - Backend profile enhancement with batch SQL queries for efficient loading
  - Automatic fallback to letter circle when image fails to load
  - Property-based integration tests: 28 tests covering avatar rendering, badge logic, and theme compatibility
  - Total test suite: 1278 tests, all passing with zero regressions
- **Private Profile Sharing via NIP-59**: Share profile information privately with contacts using encrypted messages
  - Private profiles shared per-contact via NIP-59 gift-wrapped messages
  - Automatic profile distribution on contact addition
  - Automatic broadcast to all contacts when profile is updated
  - Profile reception and storage from contacts
  - Display name precedence: alias > private profile > public profile > npub
  - Hourly public profile discovery from configured relays
  - Public profile existence indicators in UI
  - Per-contact send state tracking to prevent redundant sends
  - Database schema: nostr_profiles, nostr_profile_send_state, nostr_public_profile_presence tables
  - 6 components implemented: profile-event-builder, profile-sender, profile-receiver, profile-persistence, profile-service-integration, profile-discovery
  - Comprehensive test coverage: 121 tests (109 unit + 12 integration)
  - All critical issues fixed: signature validation clarified, display precedence fixed, race conditions resolved
  - Zero regressions vs baseline test suite
- **QR Code Contact Management**: Scan QR codes to add contacts or display identity npub as scannable QR code
  - Camera-based QR code scanning integrated into contact modal with camera icon button
  - QR code display for identities accessible from identity list
  - Theme-aware QR codes adapt foreground/background colors for light and dark themes
  - Performance optimized with 20fps scanning frame rate limiting
  - Proper camera lifecycle management with automatic cleanup and resource release
  - Database UNIQUE constraint on (identity_id, contact_npub) prevents duplicate contacts
  - Property-based integration tests: 14 tests covering scanner lifecycle, QR display, theme adaptation, and data integrity
  - Total test suite: 920 tests, all passing with zero regressions

### Fixed
- **Identity Secret Loading in Dev Mode**: Fixed secret persistence across app restarts when running with `NOSTLING_DATA_DIR` environment variable
  - Root cause: Electron's `safeStorage` API uses session-specific encryption keys that change between app restarts
  - Previously, secrets encrypted with one session's key could not be decrypted after restart, causing "Failed to load identity secret" errors
  - Fix: Detect dev mode via `NOSTLING_DATA_DIR` environment variable and skip `safeStorage` encryption, using plaintext base64 encoding instead
  - Production mode unchanged: continues to use OS keychain via `safeStorage` for secure secret storage
  - Added regression test: `e2e/bug-identity-secret-dev-mode.spec.ts` to prevent reintroduction
  - **MIGRATION**: If you have existing encrypted secrets in dev mode, run `make dev-relay-clean` to reset dev environment, then recreate identities
  - Bug report: `bug-reports/identity-secret-loading-dev-mode-report.md`
- Fixed duplicate event ingestion in Nostling conversations (message deduplication)
  - Events with the same event_id can now be ingested only once per conversation (identity_id + contact_id pair)
  - Same event_id can appear in different conversations (per-conversation deduplication, not global)
  - Root cause: No database-level unique constraint on (identity_id, contact_id, event_id)
  - Added composite UNIQUE index on (identity_id, contact_id, event_id) for non-NULL event_id values
  - Added service-level check for duplicate event_id before insertion
  - Migration automatically cleans up existing duplicates (keeps newest by timestamp)
  - Added regression tests to prevent recurrence
  - Bug report: bug-reports/duplicate-event-ingestion.md

### Added
- **Theme System**: Per-identity theme customization with 10 distinctive color schemes
  - 10 predefined themes: Light, Dark, Sunset, Ocean, Forest, Purple Haze, Ember, Twilight, Mint, Amber
  - Theme selector integrated into hamburger menu with visual color swatches
  - Per-identity theme persistence via SQLite database
  - Automatic theme application on identity selection
  - Invalid theme fallback to dark theme
  - Real-time theme switching with immediate UI update
  - Property-based integration tests: 54 tests covering theme persistence, application, fallback, and identity switching
  - Total test suite: 854 tests, all passing with zero regressions
- **Relay Manager Redesign**: Enhanced relay configuration with filesystem-based persistence
  - Compact table layout with high-density rows (≤36px) using @tanstack/react-table
  - Drag-and-drop reordering via dnd-kit with visual feedback
  - Per-relay read/write policies via checkbox controls (subscription vs publishing)
  - Live connection status indicators (green/yellow/red dots) based on WebSocket state
  - Filesystem-based configuration stored at `~/.config/nostling/identities/<id>/relays.json`
  - Hash-based overwrite protection using SHA-256 to detect external config changes
  - Conflict resolution modal with Reload/Overwrite/Cancel options
  - One-time idempotent migration from SQLite database to filesystem
  - Property-based integration tests: 50 tests covering table operations, drag-and-drop, policies, migration, and conflict resolution
  - Total test suite: 746 tests, all passing with zero regressions

### Added
- **Ostrich-Themed Status Messages**: Playful, randomly-selected status messages throughout the application
  - Themed alternatives for update status messages (e.g., "Standing tall" for "Up to date", "Pecking up" for "Downloading")
  - Themed alternatives for Nostling queue status (e.g., "Flock gathered" for "Queued", "Wings spread" for "Sending")
  - JSON-based configuration with 2-3 variations per status type for variety
  - Runtime validation with graceful fallback to default messages
  - Preserves all dynamic content (versions, progress percentages, counts, error messages)
  - Property-based testing: 72 new tests (11 integration, 39 update status, 22 Nostling status)
  - E2E tests updated to support random themed message selection
  - Total test suite: 640 tests, all passing with zero regressions
- **Persistence Layer**: SQLite-based application state storage with automatic schema migrations
  - SQLite database (`nostling.db`) using sql.js WebAssembly implementation
  - Knex.js-compatible migration system for schema versioning
  - Key-value state storage for application preferences and settings
  - IPC handlers: `state:get`, `state:set`, `state:delete`, `state:get-all`
  - Automatic migration execution on application startup
  - Property-based integration tests covering CRUD operations, migration sequences, and concurrency patterns
  - Database location: `{userData}/nostling.db`
- **Auto-Update Footer Integration**: Streamlined update experience with automatic checks and real-time progress
  - Automatic update checks on application startup (5-second delay) and at configurable intervals
  - Configurable check intervals: 1h, 2h, 4h, 12h, 24h, or never (default: 1 hour)
  - Real-time download progress display with percentage, transferred/total size, and download speed
  - Manual refresh control with circular arrow icon (↻) for immediate update checks
  - Combined version and update status display (e.g., "v1.0.0 • Up to date", "v1.0.0 • Update available: v1.0.1")
  - Context-aware action buttons: "Download Update" when available, "Restart to Update" when ready
  - Graceful error handling with user-friendly messages and retry capability
  - Refresh button automatically disabled during busy phases (checking, downloading, verifying)
  - Manual checks reset automatic check timer to prevent double-checking
  - Comprehensive property-based integration tests: 50 new tests covering footer behavior and auto-check lifecycle
  - Total test suite: 377 tests, all passing with zero regressions

### Changed
- Relocated update controls from sidebar to application footer for better visibility and discoverability
- Sidebar simplified: removed update-related controls and status displays (structure preserved for future features)

### Fixed
- Fixed relay publish failure - "All relay publishes failed" (Relay Publishing)
  - Messages now publish successfully to configured relays
  - Root cause: Relay read/write flags were being dropped during endpoint conversion in service.ts:498
  - Fix: Preserve read/write properties when mapping relay endpoints
  - Added regression test to verify relay endpoints preserve read/write flags from configuration
  - Bug report: bug-reports/relay-publish-all-failed-report.md
  - Fixed: 2025-12-12
- Fixed relay re-activation not working after disabling (Relay Configuration)
  - Users can now successfully re-enable relays after unchecking the "Enabled" checkbox
  - Root cause: When re-enabling, the handler preserved the disabled state (read=false, write=false) instead of restoring active state
  - Fix: When enabling a fully disabled relay (both read and write false), both are now set to true
  - Relays with partial permissions (only read or only write) preserve their specific state when re-enabled
  - Added regression test to prevent relays from becoming permanently disabled
  - Bug report: bug-reports/relay-reactivation-not-working-report.md
  - Fixed: 2025-12-12
- Fixed WebSocket implementation for Nostr relay connections in Node.js/Electron environment
  - Added ws package as WebSocket implementation for nostr-tools library
  - Root cause: nostr-tools SimplePool required explicit WebSocket for non-browser contexts
  - Used useWebSocketImplementation() to provide ws package to nostr-tools
  - Relay connections now establish successfully in Electron main process
  - Added regression tests to verify relay connections work without "WebSocket is not defined" errors
  - Bug report: bug-fix-contract-websocket.md
- Enhanced footer error display to show more of the error message
  - Added title attribute for tooltip showing full error text on hover
  - Added maxW and truncate to prevent error text from overflowing footer
  - Applied same enhancement to relay hover info display
- Fixed RelayTable layout and interaction bugs (relay configuration UI)
  - Tooltip hover on status dot no longer causes table row height to jump from 36px
  - All checkboxes (Enabled, Read, Write) now respond correctly to clicks
  - Root cause: Tooltip rendered inline without portal positioning, causing layout reflow
  - Root cause: Checkbox handlers used incorrect event type (React.ChangeEvent vs CheckboxCheckedChangeDetails)
  - Added `positioning={{ strategy: 'fixed' }}` to Tooltip.Root to prevent layout interference
  - Updated checkbox handlers to accept Chakra UI v3's CheckboxCheckedChangeDetails type
  - Added 2 regression tests to verify tooltip positioning and checkbox type safety
  - Bug report: bug-reports/relay-table-tooltip-checkbox-bug-report.md
- Fixed macOS Gatekeeper warnings on auto-updated applications (auto-updates)
  - Configured electron-builder to use unsigned builds with `identity: null`
  - Apps remain unsigned but install correctly; users approve once in System Settings
  - Root cause: electron-builder was attempting to sign with ad-hoc signature
  - Added production logging for signing configuration and update installation
  - Added regression test validating package.json configuration
  - Bug report: bug-reports/macos-gatekeeper-warning-unsigned-app.md

### Changed
- Simplified UI by removing Status Dashboard from main area
  - Moved "Last Update Check" timestamp to footer alongside version info
  - Removed InfoCard, LogPanel, and StatusDashboard components
  - Main content area now available for future features

### Added
- **Dev Mode Update Testing**: Test auto-updates locally before releasing to users
  - Automatic dev mode detection via `VITE_DEV_SERVER_URL` environment variable
  - Configure update source via `DEV_UPDATE_SOURCE` environment variable
  - Test pre-release versions with `ALLOW_PRERELEASE=true` flag
  - Production safety enforced: dev features automatically disabled in packaged builds
  - Configurable manifest fetch timeout (default: 30 seconds) prevents indefinite hangs
  - Concurrency protection: prevents race conditions from overlapping update checks
  - Comprehensive test coverage: 292 tests including property-based tests for state machine
  - Full diagnostic logging for update check process, version comparisons, and signature verification
- **GitHub Provider Hardening**: Enhanced security and stability for the update system
  - Download concurrency protection: prevents race conditions from simultaneous downloads
  - File protocol support for dev mode testing with local file:// URLs
  - URL validation at setup time with fail-fast error reporting
  - Error message sanitization: prevents sensitive implementation details from leaking in logs
  - GitHub constants extraction: single source of truth for owner/repo configuration
  - Comprehensive integration tests for E2E version transitions and dev mode patterns
  - 338 tests total with enhanced edge case coverage

### Changed
- **BREAKING**: Migrated auto-update signature verification from Ed25519 to RSA-4096
  - Update manifests now use RSA-4096 signatures (SHA-256 with RSA)
  - Build script requires `NOSTLING_RSA_PRIVATE_KEY` environment variable (PEM format)
  - Application requires `RSA_PUBLIC_KEY` for manifest verification (PEM format)
  - **Migration Required**: Developers and CI/CD pipelines must generate new RSA-4096 keypairs
  - See README.md "RSA Key Setup" section for key generation and configuration instructions

### Fixed
- Fixed manifest.json missing macOS .dmg artifact in GitHub releases, breaking auto-update for macOS users
  - Root cause: Manifest generated on ubuntu-latest runner before macOS artifacts available
  - Moved manifest generation from build job to create-release job after all artifacts consolidated
  - Added manifest validation to verify all expected platform artifacts present
  - Deleted dead code: manifest-generator.ts and its test (superseded by inline generation)
  - Added 5 regression tests to verify manifest includes all platform artifacts
  - Bug report: bug-reports/manifest-missing-artifacts-report.md
- Fixed duplicate release asset uploads in release workflow
  - Root cause: Glob pattern matched identical filenames (builder-debug.yml, app-update.yml) from both platform builds, causing upload conflicts
  - Changed pattern from `**/*.yml` to `**/latest-*.yml` to match only platform-specific update files
  - Added regression test to verify no duplicate basenames in upload patterns
  - Bug report: bug-reports/duplicate-release-assets-upload-report.md
- Fixed auto-update 404 error when checking for updates
  - Root cause: setupUpdater() did not configure electron-updater's feed URL, causing it to default to GitHub provider which expects latest-mac.yml instead of manifest.json
  - Added setFeedURL() call with generic provider configuration
  - Added regression tests to verify generic provider configuration
  - Bug report: bug-reports/bug-auto-update-404.md
- Fixed crypto test error handling assertion to use duck-typing instead of instanceof check
  - Root cause: Error constructors don't preserve instanceof across module boundaries in Jest
  - Updated assertion to check error message content instead of error type
  - Bug report: bug-reports/crypto-test-error-handling.md
- Fixed window creation timing race condition in E2E tests
  - Root cause: Window loaded event fired before IPC handlers were registered
  - Added proper await for DOM content loaded state before launching app
  - Ensures renderer is ready before test interactions
  - Bug report: bug-reports/window-creation-timing.md
- Fixed missing IPC handler errors in E2E tests by adding legacy handler compatibility
  - Root cause: Tests referenced deprecated IPC handlers that were removed in refactoring
  - Added three legacy handlers: get-app-version, get-platform, and open-external-link
  - Maintains backward compatibility with existing test suite
  - Bug report: bug-reports/ipc-handler-registration.md
- Fixed electronApp.evaluate() context isolation violations in E2E tests
  - Root cause: require() calls in evaluate() broke Electron's context isolation
  - Replaced require() with conditional imports and native Node.js modules
  - Ensures tests run in proper sandboxed contexts
  - Bug report: bug-reports/electron-app-evaluate.md
- Removed unused app import that caused dead code warning
  - Cleaned up imports to eliminate unnecessary dependencies
- Fixed download update button calling checkForUpdates() instead of downloadUpdate()
  - Root cause: handlePrimary() called onCheck() for all non-ready phases including 'available'
  - Added explicit else-if case for 'available' phase to call onDownload()
  - Added error handling for async IPC calls with proper error state transitions
  - Disabled button during 'checking' phase to prevent user-triggered concurrency issues
  - Added regression test to verify download button behavior
  - Bug report: bug-reports/download-update-button-not-working-report.md
- Fixed footer timestamp not updating immediately when update checks complete
  - Root cause: onUpdateState listener only updated updateState, not full AppStatus including lastUpdateCheck
  - Footer displayed stale "Not yet checked" until user manually reloaded page
  - Added status refresh when update check completes (idle/failed states)
  - Added regression tests to verify timestamp updates for all check completion scenarios
  - Bug report: bug-reports/footer-timestamp-not-updating-report.md
- Fixed update signature verification failure after clicking "Restart to Update" button (auto-updates)
  - Changed autoUpdater.autoInstallOnAppQuit from false to true
  - Moves Squirrel.Mac verification to download phase instead of quitAndInstall phase
  - Prevents "Manifest signature verification failed" error when restarting to install update
  - Root cause: With autoInstallOnAppQuit=false, quitAndInstall() triggered Squirrel.Mac to re-fetch and verify update, failing on ad-hoc signed apps
  - Added regression test verifying autoInstallOnAppQuit=true is set correctly
  - Bug report: bug-reports/0015-update-signature-verification-after-restart-report.md
  - NOTE: Requires manual testing on macOS arm64 to confirm Squirrel.Mac accepts ad-hoc signed apps with this configuration
- Fixed update not installed after restart causing re-download loop (auto-updates)
  - Changed restartToUpdate() to use app.quit() instead of autoUpdater.quitAndInstall()
  - Prevents redundant install attempts and repeated Gatekeeper warnings on macOS
  - Root cause: quitAndInstall() incompatible with autoInstallOnAppQuit=true causing conflicting install mechanisms
  - Added pre-quit validation to ensure autoInstallOnAppQuit is enabled
  - Added runtime concurrency guard to prevent race conditions during restart
  - Added 5 regression tests to verify restart behavior and configuration
  - Bug report: bug-reports/autoupdater-restart-download-loop.md
